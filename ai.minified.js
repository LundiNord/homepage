let modelLoading=!1,modelLoaded=!1;const aiWorker=new Worker("ai_worker.minified.js",{type:"module"});aiWorker.onerror=function(e){console.error(e),umami.track("Ai Worker Error",{search_data:e})};let currentResponseDiv=null;async function generateAnswer(){if(isGenerating||!input.value.trim()||!modelLoaded)return;isGenerating=!0,sendButton.style.background="gray",sendButton.textContent="Stop";const e=input.value.trim();umami.track("Ai User Message",{message_data:e}),addMessage("user",e),input.value="",currentResponseDiv=addMessage("assistant","Thinking..."),aiWorker.postMessage({message:e,topic:"input"})}aiWorker.addEventListener("message",(e=>{const{message:t,topic:n}=e.data;if("output"===n)currentResponseDiv&&(currentResponseDiv.textContent=t,chatMessages.scrollTop=chatMessages.scrollHeight);else if("loaded"===n)addMessage("assistant","Hello! How can I help you today?"),sendButton.style.background="#0056b3",modelLoading=!1,modelLoaded=!0;else if("progress"===n){if(Number.isNaN(t))return;currentResponseDiv.textContent="Model "+t+"% loaded"}else"output_done"===n&&(umami.track("Ai Output",{search_data:t}),isGenerating=!1,sendButton.style.background="#0056b3",sendButton.textContent="Send")}));const input=document.getElementById("ai_input"),sendButton=document.getElementById("send-button");sendButton.style.background="gray";const chatMessages=document.getElementById("chat-messages"),modelChangeButton=document.getElementById("settings-button"),popup=document.getElementById("settings");let isGenerating=!1;function addMessage(e,t){const n=document.createElement("div");n.className=`chat-message ${e}-message`;const s=document.createElement("span");s.className="avatar",s.textContent="user"===e?"ğŸ‘¤":"ğŸ¤–";const a=document.createElement("div");return a.className="message-content",a.textContent=t,n.appendChild(s),n.appendChild(a),chatMessages.appendChild(n),chatMessages.scrollTop=chatMessages.scrollHeight,a}input.addEventListener("keyup",(function(e){"Enter"===e.key&&(e.preventDefault(),generateAnswer())})),sendButton.addEventListener("click",(()=>{isGenerating&&modelLoaded?(aiWorker.postMessage({message:"",topic:"stop"}),sendButton.textContent="Send"):generateAnswer()})),modelChangeButton.addEventListener("click",(()=>{popup.style.display=""===popup.style.display||"none"===popup.style.display?"block":"none"})),document.addEventListener("click",(e=>{"block"!==popup.style.display||popup.contains(e.target)||modelChangeButton.contains(e.target)||(popup.style.display="none")})),document.getElementById("model_medium").addEventListener("click",(e=>{modelLoading||(aiWorker.postMessage({message:"medium",topic:"model"}),currentResponseDiv=addMessage("assistant","Changing model to SmolLM2-360M-Instruct ..."),popup.style.display="none",modelLoading=!0,umami.track("Set Model",{model_data:"medium"}))})),document.getElementById("model_small").addEventListener("click",(e=>{modelLoading||(aiWorker.postMessage({message:"small",topic:"model"}),currentResponseDiv=addMessage("assistant","Changing model to SmolLM2-135M-Instruct ..."),popup.style.display="none",modelLoading=!0,umami.track("Set Model",{model_data:"small"}))})),document.getElementById("model_big").addEventListener("click",(e=>{modelLoading||(aiWorker.postMessage({message:"big",topic:"model"}),currentResponseDiv=addMessage("assistant","Changing model to SmolLM2-1.7B-Instruct ..."),popup.style.display="none",modelLoading=!0,umami.track("Set Model",{model_data:"big"}))})),window.addEventListener("DOMContentLoaded",(()=>{0===chatMessages.children.length&&addMessage("assistant","Hi! Go to Settings to choose a model and start chatting.")}));