import{getStandardLeafletMap}from"./hiking.minified.js";let wayPointList=[];const bigMap=getStandardLeafletMap("big-map");function addMarker(e){const t=new L.marker(e);return bigMap.addLayer(t),t}bigMap.setView([50,10],3),L.control.locate().addTo(bigMap);let currentLocation=null;bigMap.on("locationfound",(function(e){currentLocation=e.latlng,umami.track("Location found",{user_location:e.latlng})}));const search=document.getElementById("map-search");search.addEventListener("keyup",(function(){const e=search.value;doLocationSearch(e,0),umami.track("Location Search",{search_data:e})}));const searchResults=document.getElementById("map-search-results");search.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(searchResults.style.display="none")})),search.addEventListener("focus",(function(){""!==searchResults.innerHTML&&(searchResults.style.display="block")})),searchResults.addEventListener("click",(function(){search.focus()}));const searchApiUrl="https://api.mapbox.com/search/geocode/v6/forward",mapboxToken="pk.eyJ1Ijoibnl4bm9yZCIsImEiOiJjbTdkZDZoeGswMXpkMmlzYjZzYnNuMGthIn0.bHJF97xa3uu3Vr4xj4tgWQ";async function doLocationSearch(e,t){if(e.length<2){let e=1===t?routeStartResults:2===t?routeEndResults:searchResults;return e.innerHTML="",void(e.style.display="none")}fetch(`${searchApiUrl}?q=${e}&proximity=ip&autocomplete=true&access_token=${mapboxToken}`).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{1===t||2===t?showRoutePointSearch(e,t):showSearchResults(e)})).catch((e=>{console.error("Error:",e)}))}function showSearchResults(e){searchResults.innerHTML="",searchResults.style.display="block",e.features.forEach((e=>{const t=document.createElement("div");t.tabIndex=0,t.textContent=e.properties.name+", "+e.properties.full_address,t.textContent=t.textContent+"\n",t.style.cursor="pointer",t.addEventListener("click",(()=>{const t=e.geometry.coordinates;bigMap.setView([t[1],t[0]],15),addMarker([t[1],t[0]]),searchResults.style.display="none"})),searchResults.appendChild(t);const n=document.createElement("div");n.innerHTML="------------",n.tabIndex=-1,searchResults.appendChild(n)})),searchResults.removeChild(searchResults.lastChild)}let startCoords=null,endCoords=null;const routeStart=document.getElementById("route-start-search");routeStart.addEventListener("keyup",(function(){const e=routeStart.value;doLocationSearch(e,1),umami.track("Route Start Search",{search_data:e})}));const routeStartResults=document.getElementById("route-start-results");routeStart.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(routeStartResults.style.display="none")})),routeStart.addEventListener("focus",(function(){""!==routeStartResults.innerHTML&&(routeStartResults.style.display="block")})),routeStartResults.addEventListener("click",(function(){routeStart.focus()}));const routeEnd=document.getElementById("route-end-search");routeEnd.addEventListener("keyup",(function(){const e=routeEnd.value;doLocationSearch(e,2),umami.track("Route End Search",{search_data:e})}));const routeEndResults=document.getElementById("route-end-results");routeEnd.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(routeEndResults.style.display="none")})),routeEnd.addEventListener("focus",(function(){""!==routeEndResults.innerHTML&&(routeEndResults.style.display="block")})),routeEndResults.addEventListener("click",(function(){routeEnd.focus()}));const calcRouteButton=document.getElementById("route-button");function showRoutePointSearch(e,t){let n=1===t?routeStartResults:routeEndResults;n.innerHTML="",n.style.display="block",e.features.forEach((e=>{const o=document.createElement("div");o.tabIndex=0,o.textContent=e.properties.name+", "+e.properties.full_address,o.textContent=o.textContent+"\n",o.style.cursor="pointer",o.addEventListener("click",(()=>{n.style.display="none";const o=e.geometry.coordinates;addMarker([o[1],o[0]]),n.innerHTML="",n.style.display="none",1===t?(startCoords=o,routeStart.value=e.properties.name):(endCoords=o,routeEnd.value=e.properties.name)})),n.appendChild(o);const a=document.createElement("div");a.innerHTML="------------",a.tabIndex=-1,n.appendChild(a)})),n.removeChild(n.lastChild)}function calcRoute(){if(null==startCoords||null==endCoords)return;let e=`https://api.mapbox.com/directions/v5/mapbox/walking/${startCoords[0]},${startCoords[1]};${endCoords[0]},${endCoords[1]}?alternatives=false&geometries=geojson&language=en&overview=simplified&steps=true&access_token=${mapboxToken}`;fetch(e).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{showRoute(e)})).catch((e=>{console.error("Error:",e)})),umami.track("Route Calculated")}function showRoute(e){document.getElementById("route-info").style.display="block";let t=L.geoJSON(e.routes[0].geometry).addTo(bigMap);bigMap.fitBounds(t.getBounds());document.getElementById("route-stats").innerHTML="Duration: "+Math.round(e.routes[0].duration/60)+" min\n Distance: "+Math.round(e.routes[0].distance/1e3)+" km";const n=document.getElementById("route-instructions"),o=e.routes[0].legs[0].steps;let a="";for(const e of o)a+=`<li>${e.maneuver.instruction} for ${Math.round(e.distance/1e3*10)/10} km</li>`;n.innerHTML=`<ol>${a}</ol>`}calcRouteButton.addEventListener("click",calcRoute),document.getElementById("search-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"})),document.getElementById("route-waypoint-button").addEventListener("click",(function(){console.log("Not implemented yet")})),L.control.measure().addTo(bigMap),document.getElementById("gpx-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"})),document.getElementById("waypoint-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"}));const gpx_list=document.getElementById("gpx_list"),colors=["red","blue","green","purple","orange","darkred","lightred","darkblue","darkgreen","pink","lightblue","lightgreen","gray","black"];let colorIndex=0;async function restoreSession(){for(const[e,t]of Object.entries(localStorage))if(e.endsWith(".gpx"))addGPXToList(t,e);else{showWaypoint(e,t.split(",").map(Number))}}function addGPXToList(e,t){const n=document.createElement("div");let o;n.innerHTML='Distance: <span class="distance"></span> km\nDuration: <span class="duration"></span>\nPace: <span class="pace"></span>',new L.GPX(e,{async:!0,polyline_options:{color:colors[colorIndex]}}).on("loaded",(function(e){o=e.target,bigMap.fitBounds(o.getBounds()),n.querySelector(".distance").textContent=(o.get_distance()/1e3).toFixed(2),n.querySelector(".duration").textContent=o.get_duration_string(o.get_moving_time()),n.querySelector(".pace").textContent=o.get_duration_string(o.get_moving_pace(),!0)})).addTo(bigMap);let a=document.createElement("div"),s=document.createElement("div");s.textContent=t,s.addEventListener("click",(function(e){bigMap.fitBounds(o.getBounds())})),n.addEventListener("click",(function(e){bigMap.fitBounds(o.getBounds())}));let r=document.createElement("button");r.className="gpx_list_item_button",r.textContent="⤓",r.addEventListener("click",(function(){download(t,e),umami.track("GPX Downloaded")}));let l=document.createElement("button");l.className="gpx_list_item_button",l.textContent="❌",l.addEventListener("click",(function(){localStorage.removeItem(t),gpx_list.removeChild(a),umami.track("GPX Deleted")})),a.className="gpx_list_item",a.appendChild(s),a.appendChild(n),a.appendChild(r),a.appendChild(l),a.id=t,gpx_list.appendChild(a),colorIndex++,colorIndex>=colors.length-1&&(colorIndex=0)}function download(e,t){const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}restoreSession(),document.getElementById("gpx-file-input").addEventListener("change",(function(){let e=document.getElementById("gpx-file-input").files[0];const t=new FileReader;t.onload=function(t){localStorage.hasOwnProperty(e.name)||(addGPXToList(t.target.result,e.name),localStorage.setItem(e.name,t.target.result.toString()))},t.readAsText(e),umami.track("GPX Loaded")})),bigMap.on("click",(function(e){waypointAddMode&&(showWaypoint(null,[e.latlng.lat,e.latlng.lng]),localStorage.setItem([e.latlng.lat,e.latlng.lng].toString(),[e.latlng.lat,e.latlng.lng].toString()))}));let waypointAddMode=!1;function showWaypoint(e,t){e||(e=t);const n=addMarker(t);wayPointList.push(t,n,e);const o=document.createElement("div"),a=document.createElement("div");a.textContent=e,a.addEventListener("click",(function(e){bigMap.panTo(new L.LatLng(t[0],t[1]))}));const s=document.createElement("button");s.className="gpx_list_item_button",s.textContent="✏️",s.addEventListener("click",(function(){const e=document.createElement("input");e.value=a.textContent,e.type="text",e.accept="text/plain;charset=utf-8",e.addEventListener("keydown",(function(n){"Enter"===n.key&&(localStorage.removeItem(a.textContent),a.textContent=e.value,localStorage.setItem(a.textContent,t),o.replaceChild(a,e))})),o.replaceChild(e,a)}));const r=document.createElement("button");r.className="gpx_list_item_button",r.textContent="❌",r.addEventListener("click",(function(){bigMap.removeLayer(n);const e=wayPointList.indexOf(t);-1!==e&&wayPointList.splice(e,2),document.getElementById("waypoint_list").removeChild(o),localStorage.removeItem(a.textContent),umami.track("Waypoint Deleted")})),o.className="gpx_list_item",o.appendChild(a),o.appendChild(s),o.appendChild(r),o.id=t,document.getElementById("waypoint_list").appendChild(o)}document.getElementById("waypoint_add_button").addEventListener("click",(function(){waypointAddMode?(document.getElementById("waypoint_add_button").style.color="red",waypointAddMode=!1):(document.getElementById("waypoint_add_button").style.color="green",waypointAddMode=!0)}));