import{getStandardLeafletMap}from"./hiking.minified.js";let wayPointList=[];const bigMap=getStandardLeafletMap("big-map");function addMarker(e){const t=new L.marker(e);return bigMap.addLayer(t),t}bigMap.setView([50,10],3),L.control.locate().addTo(bigMap);let currentLocation=null;bigMap.on("locationfound",(function(e){currentLocation=e.latlng,umami.track("Location found",{user_location:e.latlng})}));const search=document.getElementById("map-search");search.addEventListener("keyup",(function(){const e=search.value;doLocationSearch(e,0),umami.track("Location Search",{search_data:e})}));const searchResults=document.getElementById("map-search-results");search.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(searchResults.style.display="none")})),search.addEventListener("focus",(function(){""!==searchResults.innerHTML&&(searchResults.style.display="block")})),searchResults.addEventListener("click",(function(){search.focus()}));const searchApiUrl="https://api.mapbox.com/search/geocode/v6/forward",mapboxToken="pk.eyJ1Ijoibnl4bm9yZCIsImEiOiJjbTgza293dGUwa2w2Mm1zN3ZuZmVia3Q3In0.ZXcKcAtVGmyoReZWMIbraw";async function doLocationSearch(e,t){if(e.length<2){let e=1===t?routeStartResults:2===t?routeEndResults:searchResults;return e.innerHTML="",void(e.style.display="none")}fetch(`${searchApiUrl}?q=${e}&proximity=ip&autocomplete=true&access_token=${mapboxToken}`).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((n=>{1===t||2===t?showRoutePointSearch(n,t,e):showSearchResults(n)})).catch((e=>{console.error("Error:",e)}))}function showSearchResults(e){searchResults.innerHTML="",searchResults.style.display="block",e.features.forEach((e=>{const t=document.createElement("div");t.tabIndex=0,t.textContent=e.properties.name+", "+e.properties.full_address,t.textContent=t.textContent+"\n",t.style.cursor="pointer",t.addEventListener("click",(()=>{const t=e.geometry.coordinates;bigMap.setView([t[1],t[0]],15),addMarker([t[1],t[0]]),searchResults.style.display="none"})),searchResults.appendChild(t);const n=document.createElement("div");n.innerHTML="------------",n.tabIndex=-1,searchResults.appendChild(n)})),searchResults.removeChild(searchResults.lastChild)}let startCoords=null,endCoords=null;const routeStart=document.getElementById("route-start-search");routeStart.addEventListener("keyup",(function(){const e=routeStart.value;doLocationSearch(e,1),umami.track("Route Start Search",{search_data:e})}));const routeStartResults=document.getElementById("route-start-results");routeStart.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(routeStartResults.style.display="none")})),routeStart.addEventListener("focus",(function(){""!==routeStartResults.innerHTML&&(routeStartResults.style.display="block")})),routeStartResults.addEventListener("click",(function(){routeStart.focus()}));const routeEnd=document.getElementById("route-end-search");routeEnd.addEventListener("keyup",(function(){const e=routeEnd.value;doLocationSearch(e,2),umami.track("Route End Search",{search_data:e})}));const routeEndResults=document.getElementById("route-end-results");routeEnd.addEventListener("blur",(function(e){e.relatedTarget&&"DIV"===e.relatedTarget.nodeName||(routeEndResults.style.display="none")})),routeEnd.addEventListener("focus",(function(){""!==routeEndResults.innerHTML&&(routeEndResults.style.display="block")})),routeEndResults.addEventListener("click",(function(){routeEnd.focus()}));const calcRouteButton=document.getElementById("route-button");function showRoutePointSearch(e,t,n){let o=1===t?routeStartResults:routeEndResults;o.innerHTML="",o.style.display="block",wayPointList.forEach((e=>{if(e[2].toLowerCase().includes(n.toLowerCase())){const n=document.createElement("div");n.textContent="📍 "+e[2],n.style.cursor="pointer",n.tabIndex=0,n.addEventListener("click",(()=>{o.style.display="none";const n=e[0],a=[n[1],n[0]];addMarker([n[1],n[0]]),o.innerHTML="",o.style.display="none",1===t?(startCoords=a,routeStart.value=e[2]):(endCoords=a,routeEnd.value=e[2])})),o.appendChild(n);const a=document.createElement("div");a.innerHTML="------------",a.tabIndex=-1,o.appendChild(a)}})),e.features.forEach((e=>{const n=document.createElement("div");n.tabIndex=0,n.textContent=e.properties.name+", "+e.properties.full_address,n.textContent=n.textContent+"\n",n.style.cursor="pointer",n.addEventListener("click",(()=>{o.style.display="none";const n=e.geometry.coordinates;addMarker([n[1],n[0]]),o.innerHTML="",o.style.display="none",1===t?(startCoords=n,routeStart.value=e.properties.name):(endCoords=n,routeEnd.value=e.properties.name)})),o.appendChild(n);const a=document.createElement("div");a.innerHTML="------------",a.tabIndex=-1,o.appendChild(a)})),o.removeChild(o.lastChild)}function calcRoute(){if(null==startCoords||null==endCoords)return;let e=`https://api.mapbox.com/directions/v5/mapbox/walking/${startCoords[0]},${startCoords[1]};${endCoords[0]},${endCoords[1]}?alternatives=false&geometries=geojson&language=en&overview=simplified&steps=true&access_token=${mapboxToken}`;fetch(e).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{showRoute(e)})).catch((e=>{console.error("Error:",e)})),umami.track("Route Calculated")}calcRouteButton.addEventListener("click",calcRoute);let lastRoute=null;function showRoute(e){document.getElementById("route-info").style.display="block",addGPXToList(getGpxFromCoordinateList(e.routes[0].geometry.coordinates),e.routes[0].legs[0].summary);document.getElementById("route-stats").innerHTML="Duration: "+Math.round(e.routes[0].duration/60)+" min\n Distance: "+Math.round(e.routes[0].distance/1e3)+" km";const t=document.getElementById("route-instructions"),n=e.routes[0].legs[0].steps;let o="";for(const e of n)o+=`<li>${e.maneuver.instruction} for ${Math.round(e.distance/1e3*10)/10} km</li>`;t.innerHTML=`<ol>${o}</ol>`}function getGpxFromCoordinateList(e){let t='<?xml version="1.0" encoding="UTF-8" standalone="no" ?>\n';t+='<gpx version="1.1" creator="HikingMapViewer">\n',t+="  <metadata>\n",t+="    <name>Route</name>\n",t+="  </metadata>\n",t+="  <trk>\n",t+="    <name>Route</name>\n",t+="    <trkseg>\n";for(const n of e)t+=`      <trkpt lat="${n[1]}" lon="${n[0]}"></trkpt>\n`;return t+="    </trkseg>\n",t+="  </trk>\n",t+="</gpx>",t}document.getElementById("search-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"})),L.control.measure().addTo(bigMap),document.getElementById("gpx-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"})),document.getElementById("waypoint-collapsible").addEventListener("click",(function(){this.classList.toggle("active");let e=this.nextElementSibling;"flex"===e.style.display?e.style.display="none":e.style.display="flex"}));const gpx_list=document.getElementById("gpx_list"),colors=["red","blue","green","purple","orange","darkred","lightred","darkblue","darkgreen","pink","lightblue","lightgreen","gray"];let colorIndex=0;async function restoreSession(){for(const[e,t]of Object.entries(localStorage))if(e.endsWith(".gpx"))addGPXToList(t,e);else if(/^-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(t.trim()))try{const n=t.split(",").map(Number);if(2!==n.length||isNaN(n[0])||isNaN(n[1]))throw new Error("Invalid coordinates");showWaypoint(e,n)}catch(t){console.error(`Error parsing waypoint from localStorage key "${e}":`,t)}}function addGPXToList(e,t){const n=document.createElement("div");let o;n.innerHTML='Distance: <span class="distance"></span> km\nDuration: <span class="duration"></span>\nPace: <span class="pace"></span>';const a=new L.GPX(e,{async:!0,polyline_options:{color:colors[colorIndex]}}).on("loaded",(function(e){o=e.target,bigMap.fitBounds(o.getBounds()),n.querySelector(".distance").textContent=(o.get_distance()/1e3).toFixed(2),n.querySelector(".duration").textContent=o.get_duration_string(o.get_moving_time()),n.querySelector(".pace").textContent=o.get_duration_string(o.get_moving_pace(),!0)})).addTo(bigMap),r=document.createElement("div"),s=document.createElement("div");s.textContent=t,s.style.color=colors[colorIndex],s.addEventListener("click",(function(e){bigMap.fitBounds(o.getBounds())})),n.addEventListener("click",(function(e){bigMap.fitBounds(o.getBounds())}));const l=document.createElement("button");l.className="gpx_list_item_button",l.textContent="⤓",l.setAttribute("data-tooltip","Download GPX"),l.addEventListener("click",(function(){download(t,e),umami.track("GPX Downloaded")}));const i=document.createElement("button");i.className="gpx_list_item_button",i.textContent="✏️",i.setAttribute("data-tooltip","Edit Line");let d=!1,c=null;i.addEventListener("click",(function(){if(d){d=!1,i.textContent="✏️",bigMap.removeLayer(c),localStorage.removeItem(t),gpx_list.removeChild(r);const e=polylineToGpx(c);localStorage.setItem(t,e),addGPXToList(e,t),c=null}else bigMap.removeLayer(a),c=gpxToPolyline(e),d=!0,i.textContent="💾"}));const u=document.createElement("button");u.className="gpx_list_item_button",u.textContent="❌",u.setAttribute("data-tooltip","Delete GPX"),u.addEventListener("click",(function(){localStorage.removeItem(t),gpx_list.removeChild(r),bigMap.removeLayer(a),umami.track("GPX Deleted")})),r.className="gpx_list_item",r.appendChild(s),r.appendChild(n),r.appendChild(l),r.appendChild(i),r.appendChild(u),r.id=t,gpx_list.appendChild(r),colorIndex++,colorIndex>=colors.length-1&&(colorIndex=0)}function download(e,t){const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}restoreSession(),document.getElementById("gpx-file-input").addEventListener("change",(function(){const e=document.getElementById("gpx-file-input").files[0],t=new FileReader;t.onload=function(t){localStorage.hasOwnProperty(e.name)||(addGPXToList(t.target.result,e.name),localStorage.setItem(e.name,t.target.result.toString()))},t.readAsText(e),umami.track("GPX Loaded")})),bigMap.on("click",(function(e){waypointAddMode&&(showWaypoint(null,[e.latlng.lat,e.latlng.lng]),localStorage.setItem([e.latlng.lat,e.latlng.lng].toString(),[e.latlng.lat,e.latlng.lng].toString()))}));let waypointAddMode=!1;function showWaypoint(e,t){e||(e=t);const n=addMarker(t);wayPointList.push([t,n,e]);const o=document.createElement("div"),a=document.createElement("div");a.textContent=e,a.addEventListener("click",(function(e){bigMap.panTo(new L.LatLng(t[0],t[1]))}));const r=document.createElement("button");r.className="gpx_list_item_button",r.textContent="✏️",r.setAttribute("data-tooltip","Rename Waypoint");let s=!1;r.addEventListener("click",(function(){const e=document.createElement("input");if(s){const e=new KeyboardEvent("keydown",{key:"Enter"});r._input.dispatchEvent(e)}else s=!0,r.textContent="💾",e.value=a.textContent,e.type="text",e.accept="text/plain;charset=utf-8",e.addEventListener("keydown",(function(n){if("Enter"===n.key){localStorage.removeItem(a.textContent),a.textContent=e.value,localStorage.setItem(a.textContent,t),o.replaceChild(a,e);const n=wayPointList.findIndex((e=>e[0][0]===t[0]&&e[0][1]===t[1]));-1!==n&&(wayPointList[n][2]=e.value),r.textContent="✏️",s=!1}})),o.replaceChild(e,a),r._input=e}));const l=document.createElement("button");l.className="gpx_list_item_button",l.textContent="❌",l.setAttribute("data-tooltip","Delete Waypoint"),l.addEventListener("click",(function(){bigMap.removeLayer(n);const e=wayPointList.findIndex((e=>e[0][0]===t[0]&&e[0][1]===t[1]));-1!==e&&wayPointList.splice(e,1),document.getElementById("waypoint_list").removeChild(o),localStorage.removeItem(a.textContent),umami.track("Waypoint Deleted")})),o.className="gpx_list_item",o.appendChild(a),o.appendChild(r),o.appendChild(l),o.id=t,document.getElementById("waypoint_list").appendChild(o)}function gpxToPolyline(e){const t=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("trkpt"),n=[];for(const e of t){const t=parseFloat(e.getAttribute("lat")),o=parseFloat(e.getAttribute("lon"));n.push([t,o])}const o=L.polyline(n,{color:colors[colorIndex]}).addTo(bigMap);return o.enableEdit(),o}function polylineToGpx(e){return getGpxFromCoordinateList(e.getLatLngs().map((e=>[e.lng,e.lat])))}document.getElementById("waypoint_add_button").addEventListener("click",(function(){waypointAddMode?(document.getElementById("waypoint_add_button").style.color="red",waypointAddMode=!1):(document.getElementById("waypoint_add_button").style.color="green",waypointAddMode=!0)})),document.getElementById("gpx_create_button").addEventListener("click",(function(){const e="New GPX "+(new Date).toISOString().split(".")[0]+".gpx",t=bigMap.getCenter(),n=polylineToGpx(L.polyline([[t.lat,t.lng],[t.lat+45e-5,t.lng]]));localStorage.setItem(e,n),addGPXToList(n,e)}));