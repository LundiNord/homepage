import{pipeline,env,TextStreamer,InterruptableStoppingCriteria}from"/libs/transformerjs/transformers.js";import"/libs/transformerjs/ort-wasm-simd-threaded.jsep.mjs";let generator;env.allowRemoteModels=!0,env.allowLocalModels=!1,env.remoteHost="https://data.nyxnord.de",env.backends.onnx.wasm.wasmPaths="/libs/transformerjs/";let modelLoading=!1;async function checkForWebGPU(){try{if(!navigator.gpu)return!1;const e=await navigator.gpu.requestAdapter();if(!e)return!1;if(!await e.requestDevice())return!1}catch(e){return!1}return!0}async function loadModel(e="medium"){let t;"medium"===e?t="models/SmolLM2-360M-Instruct":"small"===e?t="models/SmolLM2-135M-Instruct":"big"===e&&(t="models/SmolLM2-1.7B-Instruct"),modelLoading=!0,await checkForWebGPU()?(generator=await pipeline("text-generation",t,{dtype:"q4",device:"webgpu",version:"3.4.0",progress_callback:progressCallback}),console.log("loaded model with webgpu")):(generator=await pipeline("text-generation",t,{dtype:"q4",version:"3.4.0",progress_callback:progressCallback}),console.log("loaded model"),modelLoading=!1)}const progressCallback=e=>{postMessage({message:Math.floor(e.progress),topic:"progress"})};addEventListener("message",(e=>{const{message:t,topic:r}=e.data;if("input"===r)generateAnswer(t);else if("model"===r){if(modelLoading)return;loadModel(t).then((e=>postMessage({message:"",topic:"loaded"})))}else"stop"===r&&stoppingCriteria.interrupt()}));let message=[{role:"system",content:"You are a helpful assistant."}],isGenerating=!1,stoppingCriteria=new InterruptableStoppingCriteria;async function generateAnswer(e){if(isGenerating||!e||!generator)return;isGenerating=!0;let t="";try{message.push({role:"user",content:e});const r=new TextStreamer(generator.tokenizer,{skip_prompt:!0,callback_function:e=>{t+=e,postMessage({message:t,topic:"output"})}});await generator(message,{max_new_tokens:200,temperature:.7,top_p:.9,do_sample:!0,streamer:r,stoppingCriteria:stoppingCriteria})}catch(e){console.error("Error generating response:",e)}finally{isGenerating=!1,message.push({role:"system",content:t}),postMessage({message:t,topic:"output_done"})}}